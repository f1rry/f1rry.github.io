<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Scrapy爬取p站热门插图 | F1rry&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="寒假闲来无聊，又正好在学Scrapy，于是便爬个p站来玩玩。在爬的过程中，总的来说p站反爬措施不强，貌似只有防盗链的存在，连模拟登陆都不需要的样子。但还是在其中遇到了许多坑，于是就记录下来了">
<meta property="og:type" content="article">
<meta property="og:title" content="Scrapy爬取p站热门插图">
<meta property="og:url" content="http://yoursite.com/2019/02/22/Scrapy爬取p站热门插图/index.html">
<meta property="og:site_name" content="F1rry&#39;s blog">
<meta property="og:description" content="寒假闲来无聊，又正好在学Scrapy，于是便爬个p站来玩玩。在爬的过程中，总的来说p站反爬措施不强，貌似只有防盗链的存在，连模拟登陆都不需要的样子。但还是在其中遇到了许多坑，于是就记录下来了">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006buNqigy1g0fcuy8xkjj30aj01fwec.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006buNqigy1g0fcuy9df3j30ci0480so.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006buNqigy1g0fd3me8h3j30kw0b9gmj.jpg">
<meta property="og:updated_time" content="2019-02-22T10:16:39.108Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Scrapy爬取p站热门插图">
<meta name="twitter:description" content="寒假闲来无聊，又正好在学Scrapy，于是便爬个p站来玩玩。在爬的过程中，总的来说p站反爬措施不强，貌似只有防盗链的存在，连模拟登陆都不需要的样子。但还是在其中遇到了许多坑，于是就记录下来了">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006buNqigy1g0fcuy8xkjj30aj01fwec.jpg">
  
    <link rel="alternate" href="/atom.xml" title="F1rry&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://ws1.sinaimg.cn/large/007cmQxLgy1ft3ijjc4pdj30jg0lmn0c.jpg">
    <h2 class="author">f1rry</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>10</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>8</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-Scrapy爬取p站热门插图" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/02/22/Scrapy爬取p站热门插图/" class="article-date">
  <time class="post-time" datetime="2019-02-22T08:25:05.000Z" itemprop="datePublished">
    <span class="post-month">2月</span><br/>
    <span class="post-day">22</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Scrapy爬取p站热门插图
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>寒假闲来无聊，又正好在学Scrapy，于是便爬个p站来玩玩。在爬的过程中，总的来说p站反爬措施不强，貌似只有防盗链的存在，连模拟登陆都不需要的样子。但还是在其中遇到了许多坑，于是就记录下来了<br><a id="more"></a>  </p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>  p站的加载采取的是异步ajax，分析一下接口,如图<br>  很容易批量生成url，且这些接口返回的都是json数据，也很容易提取其中的数据，如图<br>  <img src="http://ww1.sinaimg.cn/large/006buNqigy1g0fcuy8xkjj30aj01fwec.jpg" alt=""><br> 具体参数如下，p参数为请求的页数，但参数tt似乎并没有什么卵用<br>   <img src="http://ww1.sinaimg.cn/large/006buNqigy1g0fcuy9df3j30ci0480so.jpg" alt=""><br> 里面的json数据<br> <img src="http://ww1.sinaimg.cn/large/006buNqigy1g0fd3me8h3j30kw0b9gmj.jpg" alt=""><br>  图上所示的url是240x480或同规格的缩略图，如果想要爬取原尺寸图片，则还需要对原尺寸图片的url进行分析，索性格式大致一样，只有后面的后缀名会有些许差别,跟缩略图的url也大体相近，如下所示  </p>
<pre><code>https://i.pximg.net/img-original/img/2019/02/21/01/22/24/（作品id）_p0(.png)或（.jpg）
</code></pre><p>   由于是两个后缀二选一，所以需要自己重写个RetryMiddleware，如当请求.jpg后缀失败的时候改用请求.png后缀  </p>
<p>  但是如果没做任何措施，爬取图片时会报403，这也就是p站防盗链在作祟，这里p站通过判断referer来作出判断，而referer经过判断，需要来源于作品展示页面，url格式大体相同，即  </p>
<pre><code>https://www.pixiv.net/member_illust.php?mode=medium&amp;illust_id=(作品id)
</code></pre><p>于是给请求头添上referer即可成功爬取图片   </p>
<h1 id="开爬"><a href="#开爬" class="headerlink" title="开爬"></a>开爬</h1><p>爬json数据url：  </p>
<pre><code>def start_requests(self):
    SSR_POSITION=self.settings.get(&apos;SSR_POSITION&apos;)
    win32api.ShellExecute(0, &apos;open&apos;, SSR_POSITION, &apos;&apos;,&apos;&apos;,1)
    base_url=&apos;https://www.pixiv.net/ranking.php?&apos;
    params={
    &apos;mode&apos;: &apos;daily&apos;,
    &apos;content&apos;: &apos;illust&apos;,
    &apos;p&apos;:1,
    &apos;format&apos;: &apos;json&apos;,
    }
    MAX_PAGE=self.settings.get(&apos;MAX_PAGE&apos;,5)
    for i in range(1,MAX_PAGE+1):
        params[&apos;p&apos;]=i
        url=base_url+urlencode(params)
        yield scrapy.Request(url,self.parse)   
</code></pre><p>重写ImagesPipeline：  </p>
<pre><code>class ImagesPivixPipeline(ImagesPipeline):
    def get_media_requests(self,item,info):
        #没有refer会报403
        referer=&apos;https://www.pixiv.net/member_illust.php?mode=medium&amp;illust_id=&apos;+item[&apos;illust_id&apos;]
        headers={
            &apos;user-agent&apos;:&apos;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36&apos;,
            &apos;referer&apos;:referer
    }
        yield Request(item[&apos;url&apos;],headers=headers,dont_filter=True)

    def item_completed(self,results,item,info):
        image_paths=[x[&apos;path&apos;] for ok,x in results if ok]
        if not image_paths:
            raise DropItem
        return item

    def file_path(self, request, response=None, info=None):
        url = request.url
        file_name = url.split(&apos;/&apos;)[-1]
        return file_name
</code></pre><p>重写RetryMiddleware：</p>
<pre><code>class MyRetryMiddleware(RetryMiddleware):
    def process_response(self, request, response, spider):
        if request.meta.get(&apos;dont_retry&apos;, False):
            return response
        if response.status in self.retry_http_codes:
            reason = response_status_message(response.status)
            part_url=request.url.split(&apos;.&apos;)
            if part_url[-1]==&quot;jpg&quot;:
                part_url[-1]=&apos;png&apos;
            else:
                part_url[-1]=&apos;jpg&apos;
            url=&apos;.&apos;.join(part_url)
            request=request.replace(url=url)
            return self._retry(request, reason, spider) or response
        return response
</code></pre><h1 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h1><p>在重写自己的重写RetryMiddleware中间件时，总是不执行自己的MyRetryMiddleware,而是去执行默认的RetryMiddleware，查资料发现在特殊情况下（如请求失败时），会执行默认的Middleware（包括RetryMiddleware），如果值低于550，则逻辑便是先执行RetryMiddleware，再执行自己的RetryMiddleware，但由于默认的的RetryMiddleware会将retry_time用光，致使自己的RetryMiddleware白写。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>反爬措施+1:判断referer<br>重写RetryMiddleware中间件时，需要注意其在settings.py中所设置的值，不然很有可能白写，如果其值低于550（即默认的RetryMiddleware值）。<br>完整代码请见 <a href="https://github.com/f1rry/scrapypivix" target="_blank" rel="noopener">github</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/02/22/Scrapy爬取p站热门插图/" data-id="cjsfwm95t0004m8vsqc5pgl37" class="article-share-link">分享</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/10/31/使用Selenium-Beautifulsoup爬取杭电学生成绩/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">使用Selenium+Beautiful Soup爬取杭电学生成绩</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">F1rry&#39;s blog</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://ws1.sinaimg.cn/large/007cmQxLgy1ft3ijjc4pdj30jg0lmn0c.jpg">
    <h2 class="author">f1rry</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>10</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>8</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="https://github.com/f1rry" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="https://brownfly.github.io/page/2/" target="_blank" title="brownfly">
          brownfly
        </a>
      
        <a class="hvr-bounce-in" href="http://blog.ckj123.com/" target="_blank" title="ckj123">
          ckj123
        </a>
      
        <a class="hvr-bounce-in" href="http://mki603.top/" target="_blank" title="Mki">
          Mki
        </a>
      
        <a class="hvr-bounce-in" href="http://blog.0e1.top/" target="_blank" title="Li4n0">
          Li4n0
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2018 - 2019 f1rry<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/f1rry/f1rry.github.io">Christina</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>